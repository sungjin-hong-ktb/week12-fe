{% extends "base.html" %}

{% block title %}비밀번호 수정 - 아무 말 대잔치{% endblock %}

{% block header_left %}
<button class="absolute left-5 top-1/2 -translate-y-1/2 bg-none border-none text-xl cursor-pointer" onclick="history.back()">‹</button>
{% endblock %}

{% block header_right %}
<div class="user-icon absolute right-5 top-1/2 -translate-y-1/2 w-[30px] h-[30px] rounded-full bg-gray-400 cursor-pointer bg-cover bg-center" id="userIcon"></div>
<div class="dropdown-menu absolute right-5 top-[60px] bg-white border border-gray-300 rounded shadow-lg hidden z-50 w-40" id="dropdownMenu">
    <button onclick="location.href='/profile/edit'" class="block w-full text-left px-5 py-3 hover:bg-[#E9E9E9] text-sm">회원정보수정</button>
    <button onclick="location.href='/password/edit'" class="block w-full text-left px-5 py-3 hover:bg-[#E9E9E9] text-sm">비밀번호수정</button>
    <button onclick="api.auth.logout()" class="block w-full text-left px-5 py-3 hover:bg-[#E9E9E9] text-sm">로그아웃</button>
</div>
{% endblock %}

{% block content %}
<div class="max-w-[600px] mx-auto p-10">
    <h2 class="text-center text-xl font-bold mb-8">비밀번호 수정</h2>

    <form id="passwordForm" class="space-y-6">
        <div class="form-group">
            <label for="password" class="block mb-2 font-medium">비밀번호</label>
            <input type="password" id="password" name="password" placeholder="비밀번호를 입력하세요" 
                   class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-[#7F6AEE]">
            <span class="helper-text text-xs text-red-500 mt-1 hidden" id="passwordHelper"></span>
        </div>

        <div class="form-group">
            <label for="passwordConfirm" class="block mb-2 font-medium">비밀번호 확인</label>
            <input type="password" id="passwordConfirm" name="passwordConfirm" placeholder="비밀번호를 한번 더 입력하세요" 
                   class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-[#7F6AEE]">
            <span class="helper-text text-xs text-red-500 mt-1 hidden" id="passwordConfirmHelper"></span>
        </div>

        <button type="submit" class="w-full bg-[#ACA0EB] text-white p-3 rounded transition-opacity mt-4 cursor-not-allowed" id="submitBtn" disabled>수정하기</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 인증 확인
    if (!utils.checkAuth()) {
        throw new Error('Unauthorized');
    }

    const passwordInput = document.getElementById('password');
    const passwordConfirmInput = document.getElementById('passwordConfirm');
    const passwordForm = document.getElementById('passwordForm');
    const submitBtn = document.getElementById('submitBtn');

    // 버튼 활성화/비활성화 확인
    function checkFormValidity() {
        const password = passwordInput.value;
        const passwordConfirm = passwordConfirmInput.value;
        const passwordHelper = document.getElementById('passwordHelper');
        const confirmHelper = document.getElementById('passwordConfirmHelper');

        const isPasswordValid = password && utils.validatePassword(password) && passwordHelper.classList.contains('hidden');
        const isConfirmValid = passwordConfirm && password === passwordConfirm && confirmHelper.classList.contains('hidden');

        if (isPasswordValid && isConfirmValid) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('bg-[#ACA0EB]', 'cursor-not-allowed');
            submitBtn.classList.add('bg-[#7F6AEE]', 'hover:opacity-90');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.remove('bg-[#7F6AEE]', 'hover:opacity-90');
            submitBtn.classList.add('bg-[#ACA0EB]', 'cursor-not-allowed');
        }
    }

    // 비밀번호 입력 검증
    passwordInput.addEventListener('input', function() {
        const value = this.value;
        const helper = document.getElementById('passwordHelper');

        if (!value) {
            helper.textContent = '비밀번호를 입력해주세요';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else if (!utils.validatePassword(value)) {
            helper.textContent = '비밀번호는 8자 이상, 20자 이하이며, 대문자, 소문자, 숫자, 특수문자를 각각 최소 1개 포함해야 합니다';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else {
            helper.classList.add('hidden');
            helper.classList.remove('block');
        }

        // 비밀번호 확인 재검증
        if (passwordConfirmInput.value) {
            passwordConfirmInput.dispatchEvent(new Event('input'));
        }

        checkFormValidity();
    });

    // 비밀번호 확인 입력 검증
    passwordConfirmInput.addEventListener('input', function() {
        const value = this.value;
        const helper = document.getElementById('passwordConfirmHelper');

        if (!value) {
            helper.textContent = '비밀번호를 한번 더 입력해주세요';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else if (value !== passwordInput.value) {
            helper.textContent = '비밀번호가 다릅니다';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else {
            helper.classList.add('hidden');
            helper.classList.remove('block');
        }

        checkFormValidity();
    });

    // 비밀번호 수정
    passwordForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const password = passwordInput.value;
        const passwordConfirm = passwordConfirmInput.value;

        // 유효성 검사
        let hasError = false;

        if (!password) {
            document.getElementById('passwordHelper').textContent = '비밀번호를 입력해주세요';
            document.getElementById('passwordHelper').classList.remove('hidden');
            document.getElementById('passwordHelper').classList.add('block');
            hasError = true;
        } else if (!utils.validatePassword(password)) {
            document.getElementById('passwordHelper').textContent = '비밀번호는 8자 이상, 20자 이하이며, 대문자, 소문자, 숫자, 특수문자를 각각 최소 1개 포함해야 합니다';
            document.getElementById('passwordHelper').classList.remove('hidden');
            document.getElementById('passwordHelper').classList.add('block');
            hasError = true;
        }

        if (!passwordConfirm) {
            document.getElementById('passwordConfirmHelper').textContent = '비밀번호를 한번 더 입력해주세요';
            document.getElementById('passwordConfirmHelper').classList.remove('hidden');
            document.getElementById('passwordConfirmHelper').classList.add('block');
            hasError = true;
        } else if (password !== passwordConfirm) {
            document.getElementById('passwordConfirmHelper').textContent = '비밀번호가 다릅니다';
            document.getElementById('passwordConfirmHelper').classList.remove('hidden');
            document.getElementById('passwordConfirmHelper').classList.add('block');
            hasError = true;
        }

        if (hasError) return;

        submitBtn.disabled = true;
        submitBtn.textContent = '수정 중...';

        try {
            const userId = storage.getUserId();
            await api.users.updatePassword(userId, password);

            utils.showSuccess('수정 완료');
            setTimeout(() => {
                location.href = '/posts';
            }, 1500);
        } catch (error) {
            console.error('Update password error:', error);
            utils.showError(error.message || '비밀번호 수정에 실패했습니다');
            submitBtn.disabled = false;
            submitBtn.textContent = '수정하기';
        }
    });
</script>
{% endblock %}