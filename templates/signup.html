{% extends "base.html" %}

{% block title %}회원가입 - 아무 말 대잔치{% endblock %}

{% block header_left %}
<button class="absolute left-5 top-1/2 -translate-y-1/2 bg-none border-none text-xl cursor-pointer" onclick="history.back()">‹</button>
{% endblock %}

{% block header_right %}
<!-- 회원가입 페이지는 헤더 우측 메뉴 없음 -->
{% endblock %}

{% block home_link %}/{% endblock %}

{% block content %}
<div class="max-w-[600px] mx-auto p-10">
    <h2 class="text-center text-2xl font-bold mb-8">회원가입</h2>

    <div class="text-center mb-8">
        <div class="w-[150px] h-[150px] rounded-full bg-gray-200 inline-flex items-center justify-center cursor-pointer relative overflow-hidden mx-auto" id="profileImageContainer">
            <span class="text-4xl text-gray-400">+</span>
            <input type="file" id="profileImage" accept="image/*" class="hidden">
        </div>
        <p class="text-xs text-red-500 mt-1 hidden" id="profileHelper">프로필 사진을 추가해주세요</p>
    </div>

    <form id="signupForm" class="space-y-5">
        <div class="form-group">
            <label for="email" class="block mb-1 font-medium">이메일<span class="text-red-500">*</span></label>
            <input type="email" id="email" name="email" placeholder="이메일을 입력하세요"
                   class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-[#7F6AEE]">
            <span class="helper-text text-xs text-red-500 mt-1 hidden" id="emailHelper"></span>
        </div>

        <div class="form-group">
            <label for="password" class="block mb-1 font-medium">비밀번호<span class="text-red-500">*</span></label>
            <input type="password" id="password" name="password" placeholder="비밀번호를 입력하세요"
                   class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-[#7F6AEE]">
            <span class="helper-text text-xs text-red-500 mt-1 hidden" id="passwordHelper"></span>
        </div>

        <div class="form-group">
            <label for="passwordConfirm" class="block mb-1 font-medium">비밀번호 확인<span class="text-red-500">*</span></label>
            <input type="password" id="passwordConfirm" name="passwordConfirm" placeholder="비밀번호를 한번 더 입력하세요"
                   class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-[#7F6AEE]">
            <span class="helper-text text-xs text-red-500 mt-1 hidden" id="passwordConfirmHelper"></span>
        </div>

        <div class="form-group">
            <label for="nickname" class="block mb-1 font-medium">닉네임<span class="text-red-500">*</span></label>
            <input type="text" id="nickname" name="nickname" placeholder="닉네임을 입력하세요" maxlength="10"
                   class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-[#7F6AEE]">
            <span class="helper-text text-xs text-red-500 mt-1 hidden" id="nicknameHelper"></span>
        </div>

        <button type="submit" class="w-full bg-[#7F6AEE] text-white p-3 rounded hover:opacity-80 transition-opacity mt-2" id="signupBtn">회원가입</button>
        <button type="button" class="w-full bg-white text-gray-800 border border-gray-300 p-3 rounded hover:bg-gray-50 transition-colors mt-3" onclick="location.href='/'">로그인하러 가기</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const profileImageContainer = document.getElementById('profileImageContainer');
    const profileImageInput = document.getElementById('profileImage');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const passwordConfirmInput = document.getElementById('passwordConfirm');
    const nicknameInput = document.getElementById('nickname');
    const signupForm = document.getElementById('signupForm');
    const signupBtn = document.getElementById('signupBtn');

    let selectedImage = null;

    // 프로필 이미지 클릭
    profileImageContainer.addEventListener('click', function() {
        profileImageInput.click();
    });

    // 프로필 이미지 변경
    profileImageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // 파일 크기 체크 (4MB 이하)
            if (file.size > 4 * 1024 * 1024) {
                utils.showError('이미지 파일 크기는 4MB 이하여야 합니다');
                this.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                profileImageContainer.innerHTML = `<img src="${e.target.result}" alt="Profile" class="w-full h-full object-cover">`;
                selectedImage = file;
            };
            reader.readAsDataURL(file);
        }
    });

    // 이메일 입력 검증
    emailInput.addEventListener('input', function() {
        const value = this.value.trim();
        const helper = document.getElementById('emailHelper');

        if (!value) {
            helper.textContent = '이메일을 입력해주세요';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else if (!utils.validateEmail(value)) {
            helper.textContent = '올바른 이메일 주소 형식을 입력해주세요. (예: example@example.com)';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else {
            helper.classList.add('hidden');
            helper.classList.remove('block');
        }
    });

    // 비밀번호 입력 검증
    passwordInput.addEventListener('input', function() {
        const value = this.value;
        const helper = document.getElementById('passwordHelper');

        if (!value) {
            helper.textContent = '비밀번호를 입력해주세요';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else if (!utils.validatePassword(value)) {
            helper.textContent = '비밀번호는 8자 이상, 20자 이하이며, 대문자, 소문자, 숫자, 특수문자를 각각 최소 1개 포함해야 합니다';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else {
            helper.classList.add('hidden');
            helper.classList.remove('block');
        }

        // 비밀번호 확인 재검증
        if (passwordConfirmInput.value) {
            passwordConfirmInput.dispatchEvent(new Event('input'));
        }
    });

    // 비밀번호 확인 입력 검증
    passwordConfirmInput.addEventListener('input', function() {
        const value = this.value;
        const helper = document.getElementById('passwordConfirmHelper');

        if (!value) {
            helper.textContent = '비밀번호를 한번 더 입력해주세요';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else if (value !== passwordInput.value) {
            helper.textContent = '비밀번호가 다릅니다';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else {
            helper.classList.add('hidden');
            helper.classList.remove('block');
        }
    });

    // 닉네임 입력 검증
    nicknameInput.addEventListener('input', function() {
        const value = this.value;
        const helper = document.getElementById('nicknameHelper');

        if (!value) {
            helper.textContent = '닉네임을 입력해주세요';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else if (value.includes(' ')) {
            helper.textContent = '띄어쓰기를 없애주세요';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else if (value.length > 10) {
            helper.textContent = '닉네임은 최대 10자까지 작성 가능합니다';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else {
            helper.classList.add('hidden');
            helper.classList.remove('block');
        }
    });

    // 회원가입 폼 제출
    signupForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const passwordConfirm = passwordConfirmInput.value;
        const nickname = nicknameInput.value.trim();

        // 유효성 검사
        let hasError = false;

        if (!email) {
            document.getElementById('emailHelper').textContent = '이메일을 입력해주세요';
            document.getElementById('emailHelper').classList.remove('hidden');
            document.getElementById('emailHelper').classList.add('block');
            hasError = true;
        } else if (!utils.validateEmail(email)) {
            document.getElementById('emailHelper').textContent = '올바른 이메일 주소 형식을 입력해주세요. (예: example@example.com)';
            document.getElementById('emailHelper').classList.remove('hidden');
            document.getElementById('emailHelper').classList.add('block');
            hasError = true;
        }

        if (!password) {
            document.getElementById('passwordHelper').textContent = '비밀번호를 입력해주세요';
            document.getElementById('passwordHelper').classList.remove('hidden');
            document.getElementById('passwordHelper').classList.add('block');
            hasError = true;
        } else if (!utils.validatePassword(password)) {
            document.getElementById('passwordHelper').textContent = '비밀번호는 8자 이상, 20자 이하이며, 대문자, 소문자, 숫자, 특수문자를 각각 최소 1개 포함해야 합니다';
            document.getElementById('passwordHelper').classList.remove('hidden');
            document.getElementById('passwordHelper').classList.add('block');
            hasError = true;
        }

        if (!passwordConfirm) {
            document.getElementById('passwordConfirmHelper').textContent = '비밀번호를 한번 더 입력해주세요';
            document.getElementById('passwordConfirmHelper').classList.remove('hidden');
            document.getElementById('passwordConfirmHelper').classList.add('block');
            hasError = true;
        } else if (password !== passwordConfirm) {
            document.getElementById('passwordConfirmHelper').textContent = '비밀번호가 다릅니다';
            document.getElementById('passwordConfirmHelper').classList.remove('hidden');
            document.getElementById('passwordConfirmHelper').classList.add('block');
            hasError = true;
        }

        if (!nickname) {
            document.getElementById('nicknameHelper').textContent = '닉네임을 입력해주세요';
            document.getElementById('nicknameHelper').classList.remove('hidden');
            document.getElementById('nicknameHelper').classList.add('block');
            hasError = true;
        } else if (nickname.includes(' ')) {
            document.getElementById('nicknameHelper').textContent = '띄어쓰기를 없애주세요';
            document.getElementById('nicknameHelper').classList.remove('hidden');
            document.getElementById('nicknameHelper').classList.add('block');
            hasError = true;
        } else if (nickname.length > 10) {
            document.getElementById('nicknameHelper').textContent = '닉네임은 최대 10자까지 작성 가능합니다';
            document.getElementById('nicknameHelper').classList.remove('hidden');
            document.getElementById('nicknameHelper').classList.add('block');
            hasError = true;
        }

        if (hasError) {
            return;
        }

        // 회원가입 버튼 비활성화
        signupBtn.disabled = true;
        signupBtn.textContent = '회원가입 중...';

        try {
            let profileImageUrl = null;
            if (selectedImage) {
                try {
                    const uploadResult = await api.files.upload(selectedImage);
                    profileImageUrl = uploadResult.url;
                } catch (uploadError) {
                    console.error('Image upload error:', uploadError);
                    utils.showError('이미지 업로드에 실패했습니다');
                    signupBtn.disabled = false;
                    signupBtn.textContent = '회원가입';
                    return;
                }
            }

            const userData = {
                email: email,
                password: password,
                password_confirm: passwordConfirm,
                nickname: nickname,
                profile_image: profileImageUrl
            };

            const result = await api.users.create(userData);

            utils.showSuccess('회원가입이 완료되었습니다');

            // 토스트 메시지를 보여준 후 로그인 페이지로 이동
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } catch (error) {
            console.error('Signup error:', error);
            utils.showError(error.message || '회원가입에 실패했습니다');

            // 에러 발생 시에만 버튼 활성화
            signupBtn.disabled = false;
            signupBtn.textContent = '회원가입';
        }
    });
</script>
{% endblock %}