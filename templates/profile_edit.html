{% extends "base.html" %}

{% block title %}회원정보수정 - 아무 말 대잔치{% endblock %}

{% block header_left %}
<button class="absolute left-5 top-1/2 -translate-y-1/2 bg-none border-none text-xl cursor-pointer" onclick="history.back()">‹</button>
{% endblock %}

{% block header_right %}
<div class="user-icon absolute right-5 top-1/2 -translate-y-1/2 w-[30px] h-[30px] rounded-full bg-gray-400 cursor-pointer bg-cover bg-center" id="userIcon"></div>
<div class="dropdown-menu absolute right-5 top-[60px] bg-white border border-gray-300 rounded shadow-lg hidden z-50 w-40" id="dropdownMenu">
    <button onclick="location.href='/profile/edit'" class="block w-full text-left px-5 py-3 hover:bg-[#E9E9E9] text-sm">회원정보수정</button>
    <button onclick="location.href='/password/edit'" class="block w-full text-left px-5 py-3 hover:bg-[#E9E9E9] text-sm">비밀번호수정</button>
    <button onclick="api.auth.logout()" class="block w-full text-left px-5 py-3 hover:bg-[#E9E9E9] text-sm">로그아웃</button>
</div>
{% endblock %}

{% block content %}
<div class="max-w-[600px] mx-auto p-10">
    <h2 class="text-center text-xl font-bold mb-8">회원정보수정</h2>

    <div class="text-center mb-8">
        <label class="block mb-2 font-medium">프로필 사진<span class="text-red-500">*</span></label>
        <div class="w-[150px] h-[150px] rounded-full bg-gray-200 inline-flex items-center justify-center cursor-pointer relative overflow-hidden mx-auto" id="profileImageContainer">
            <span class="text-gray-500 text-sm">변경</span>
            <input type="file" id="profileImage" accept="image/*" class="hidden">
        </div>
    </div>

    <form id="profileForm" class="space-y-6">
        <div class="form-group">
            <label for="email" class="block mb-2 font-medium">이메일</label>
            <div id="email" class="w-full p-3 bg-gray-50 border border-gray-300 rounded text-gray-600"></div>
        </div>

        <div class="form-group">
            <label for="nickname" class="block mb-2 font-medium">닉네임</label>
            <input type="text" id="nickname" name="nickname" placeholder="닉네임을 입력하세요" maxlength="10" 
                   class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-[#7F6AEE]">
            <span class="helper-text text-xs text-red-500 mt-1 hidden" id="nicknameHelper"></span>
        </div>

        <button type="submit" class="w-full bg-[#7F6AEE] text-white p-3 rounded hover:opacity-90 transition-opacity mt-4" id="submitBtn">수정하기</button>
        <button type="button" class="w-full bg-white text-gray-800 border border-gray-300 p-3 rounded hover:bg-gray-50 transition-colors mt-3" onclick="openDeleteModal()">회원 탈퇴</button>
    </form>

    <!-- 회원 탈퇴 확인 모달 -->
    <div class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" id="deleteModal">
        <div class="bg-white p-8 rounded-lg max-w-sm w-[90%] text-center shadow-xl">
            <h3 class="text-lg font-bold mb-4">회원탈퇴 하시겠습니까?</h3>
            <p class="text-gray-600 mb-6">작성된 게시글과 댓글은 삭제됩니다.</p>
            <div class="flex gap-3">
                <button class="flex-1 bg-gray-800 text-white py-3 rounded hover:bg-gray-700" onclick="closeDeleteModal()">취소</button>
                <button class="flex-1 bg-[#7F6AEE] text-white py-3 rounded hover:opacity-90" onclick="confirmDelete()">확인</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* 모달 백그라운드 스크롤 방지 */
    body.modal-open {
        overflow: hidden;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // 인증 확인
    if (!utils.checkAuth()) {
        throw new Error('Unauthorized');
    }

    const emailInput = document.getElementById('email');
    const nicknameInput = document.getElementById('nickname');
    const profileForm = document.getElementById('profileForm');
    const submitBtn = document.getElementById('submitBtn');
    const profileImageContainer = document.getElementById('profileImageContainer');
    const profileImageInput = document.getElementById('profileImage');

    let selectedImage = null;

    // 프로필 이미지 클릭
    profileImageContainer.addEventListener('click', function() {
        profileImageInput.click();
    });

    // 프로필 이미지 변경
    profileImageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            if (file.size > 4 * 1024 * 1024) {
                utils.showError('이미지 파일 크기는 4MB 이하여야 합니다');
                this.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                profileImageContainer.innerHTML = `<img src="${e.target.result}" alt="Profile" class="w-full h-full object-cover">`;
                selectedImage = file;
            };
            reader.readAsDataURL(file);
        }
    });

    // 사용자 정보 로드
    async function loadUserInfo() {
        try {
            const userId = storage.getUserId();
            const user = await api.users.get(userId);
            emailInput.textContent = user.email;
            nicknameInput.value = user.nickname;
            if (user.profile_image) {
                profileImageContainer.innerHTML = `<img src="${user.profile_image}" alt="Profile" class="w-full h-full object-cover">`;
            }
        } catch (error) {
            console.error('Load user error:', error);
            utils.showError('사용자 정보를 불러오는데 실패했습니다');
        }
    }

    // 닉네임 입력 검증
    nicknameInput.addEventListener('input', function() {
        const value = this.value;
        const helper = document.getElementById('nicknameHelper');

        if (!value) {
            helper.textContent = '닉네임을 입력해주세요';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else if (value.includes(' ')) {
            helper.textContent = '띄어쓰기를 없애주세요';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else if (value.length > 10) {
            helper.textContent = '닉네임은 최대 10자까지 작성 가능합니다';
            helper.classList.remove('hidden');
            helper.classList.add('block');
        } else {
            helper.classList.add('hidden');
            helper.classList.remove('block');
        }
    });

    // 프로필 수정
    profileForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const nickname = nicknameInput.value.trim();

        // 유효성 검사
        if (!nickname) {
            document.getElementById('nicknameHelper').textContent = '닉네임을 입력해주세요';
            document.getElementById('nicknameHelper').classList.remove('hidden');
            document.getElementById('nicknameHelper').classList.add('block');
            return;
        }

        if (nickname.includes(' ')) {
            document.getElementById('nicknameHelper').textContent = '띄어쓰기를 없애주세요';
            document.getElementById('nicknameHelper').classList.remove('hidden');
            document.getElementById('nicknameHelper').classList.add('block');
            return;
        }

        if (nickname.length > 10) {
            document.getElementById('nicknameHelper').textContent = '닉네임은 최대 10자까지 작성 가능합니다';
            document.getElementById('nicknameHelper').classList.remove('hidden');
            document.getElementById('nicknameHelper').classList.add('block');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = '수정 중...';

        try {
            const userId = storage.getUserId();
            const updateData = { nickname };

            if (selectedImage === 'RESET') {
                updateData.profile_image = '';
            } else if (selectedImage) {
                const uploadResult = await api.files.upload(selectedImage);
                updateData.profile_image = uploadResult.url;
            }

            await api.users.update(userId, updateData);

            utils.showSuccess('수정 완료');
            setTimeout(() => {
                location.href = '/posts';
            }, 1500);
        } catch (error) {
            console.error('Update profile error:', error);
            utils.showError(error.message || '프로필 수정에 실패했습니다');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '수정하기';
        }
    });

    function openDeleteModal() {
        document.getElementById('deleteModal').classList.remove('hidden');
        document.getElementById('deleteModal').classList.add('flex');
        document.body.classList.add('modal-open');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
        document.getElementById('deleteModal').classList.remove('flex');
        document.body.classList.remove('modal-open');
    }

    async function confirmDelete() {
        try {
            const userId = storage.getUserId();
            await api.users.delete(userId);
            utils.showSuccess('회원 탈퇴가 완료되었습니다');
            api.auth.logout();
        } catch (error) {
            console.error('Delete user error:', error);
            utils.showError(error.message || '회원 탈퇴에 실패했습니다');
        }
        closeDeleteModal();
    }

    // 초기 로드
    utils.loadUserProfileImage();
    loadUserInfo();
</script>
{% endblock %}