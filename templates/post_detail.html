{% extends "base.html" %}

{% block title %}게시글 상세 - 아무 말 대잔치{% endblock %}

{% block header_left %}
<button class="absolute left-5 top-1/2 -translate-y-1/2 bg-none border-none text-xl cursor-pointer" onclick="history.back()">‹</button>
{% endblock %}

{% block header_right %}
<div class="user-icon absolute right-5 top-1/2 -translate-y-1/2 w-[30px] h-[30px] rounded-full bg-gray-400 cursor-pointer bg-cover bg-center" id="userIcon"></div>
<div class="dropdown-menu absolute right-5 top-[60px] bg-white border border-gray-300 rounded shadow-lg hidden z-50 w-40" id="dropdownMenu">
    <button onclick="location.href='/profile/edit'" class="block w-full text-left px-5 py-3 hover:bg-gray-100 text-sm">회원정보수정</button>
    <button onclick="location.href='/password/edit'" class="block w-full text-left px-5 py-3 hover:bg-gray-100 text-sm">비밀번호수정</button>
    <button onclick="api.auth.logout()" class="block w-full text-left px-5 py-3 hover:bg-gray-100 text-sm">로그아웃</button>
</div>
{% endblock %}

{% block content %}
<div class="max-w-[700px] mx-auto px-5 py-10">
    <div id="postDetail">
        <!-- 게시글 상세 내용이 여기에 표시됩니다 -->
        <div class="text-center py-10 text-gray-500">로딩 중...</div>
    </div>

    <!-- 통계 박스 -->
    <div class="flex justify-between gap-3 mb-10" id="postStats">
        <div class="flex-1 bg-[#D9D9D9] rounded-xl p-5 text-center flex flex-col items-center justify-center cursor-pointer transition-colors" id="likeBox" onclick="toggleLike()">
            <div class="text-lg font-bold text-gray-800 mb-1" id="likeCount">0</div>
            <div class="text-sm text-gray-500">좋아요수</div>
        </div>
        <div class="flex-1 bg-[#D9D9D9] rounded-xl p-5 text-center flex flex-col items-center justify-center">
            <div class="text-lg font-bold text-gray-800 mb-1" id="viewCount">0</div>
            <div class="text-sm text-gray-500">조회수</div>
        </div>
        <div class="flex-1 bg-[#D9D9D9] rounded-xl p-5 text-center flex flex-col items-center justify-center">
            <div class="text-lg font-bold text-gray-800 mb-1" id="commentCount">0</div>
            <div class="text-sm text-gray-500">댓글</div>
        </div>
    </div>

    <!-- 댓글 섹션 -->
    <div class="border-t border-gray-200 pt-10">
        <h3 class="text-lg font-bold mb-4">댓글</h3>

        <div class="mb-8">
            <textarea id="commentInput" placeholder="댓글을 남겨주세요" class="w-full p-3 border border-gray-300 rounded-md min-h-[80px] resize-y focus:outline-none focus:border-[#7F6AEE] mb-3" oninput="updateCommentButton()"></textarea>
            <div class="text-right">
                <button id="commentSubmitBtn" class="bg-[#ACA0EB] text-white px-8 py-2 rounded-lg transition-opacity" disabled onclick="submitComment()">댓글 등록</button>
            </div>
        </div>

        <div id="commentsList" class="space-y-4">
            <!-- 댓글 목록이 여기에 표시됩니다 -->
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" id="deleteModal">
        <div class="bg-white p-8 rounded-lg max-w-sm w-[90%] text-center shadow-xl">
            <h3 class="text-lg font-bold mb-4">게시글을 삭제하시겠습니까?</h3>
            <p class="text-gray-600 mb-6">삭제한 내용은 복구 할 수 없습니다.</p>
            <div class="flex gap-3">
                <button class="flex-1 bg-gray-800 text-white py-3 rounded hover:bg-gray-700" onclick="closeDeleteModal()">취소</button>
                <button class="flex-1 bg-[#7F6AEE] text-white py-3 rounded hover:opacity-90" onclick="confirmDelete()">확인</button>
            </div>
        </div>
    </div>

    <!-- 댓글 삭제 확인 모달 -->
    <div class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" id="deleteCommentModal">
        <div class="bg-white p-8 rounded-lg max-w-sm w-[90%] text-center shadow-xl">
            <h3 class="text-lg font-bold mb-4">댓글을 삭제하시겠습니까?</h3>
            <p class="text-gray-600 mb-6">삭제한 내용은 복구 할 수 없습니다.</p>
            <div class="flex gap-3">
                <button class="flex-1 bg-gray-800 text-white py-3 rounded hover:bg-gray-700" onclick="closeDeleteCommentModal()">취소</button>
                <button class="flex-1 bg-[#7F6AEE] text-white py-3 rounded hover:opacity-90" onclick="confirmDeleteComment()">확인</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* 좋아요 활성화 상태 */
    #likeBox.active {
        background-color: #ACA0EB;
    }
    #likeBox.active div {
        color: white;
    }

    /* 모달 백그라운드 스크롤/클릭 방지 */
    body.modal-open {
        overflow: hidden;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // 인증 확인
    if (!utils.checkAuth()) {
        throw new Error('Unauthorized');
    }

    const postId = window.location.pathname.split('/').pop();
    let currentPost = null;
    let deleteCommentId = null;
    let editingCommentId = null;

    // 좋아요 상태 로드
    async function loadLikeStatus() {
        try {
            const status = await api.likes.getStatus(postId);
            updateLikeButton(status.liked);
        } catch (error) {
            console.error('Load like status error:', error);
        }
    }

    // 좋아요 토글
    async function toggleLike() {
        try {
            const likeBox = document.getElementById('likeBox');
            const wasLiked = likeBox.classList.contains('active');
            
            const result = await api.likes.toggle(postId);
            
            updateLikeButton(result.liked);
            
            const likeCountElement = document.getElementById('likeCount');
            let currentText = likeCountElement.textContent.replace(/,/g, '');
            
            if (currentText.includes('k')) return;
            
            let count = parseInt(currentText);
            if (!isNaN(count)) {
                if (result.liked && !wasLiked) {
                    count++;
                } else if (!result.liked && wasLiked) {
                    count = Math.max(0, count - 1);
                }
                likeCountElement.textContent = utils.formatNumber(count);
            }
            
        } catch (error) {
            console.error('Toggle like error:', error);
            utils.showError('좋아요 처리에 실패했습니다');
        }
    }

    function updateLikeButton(liked) {
        const likeBox = document.getElementById('likeBox');
        if (liked) {
            likeBox.classList.add('active');
        } else {
            likeBox.classList.remove('active');
        }
    }

    // HTML 이스케이프
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 댓글 버튼 활성화/비활성화
    function updateCommentButton() {
        const commentInput = document.getElementById('commentInput');
        const submitBtn = document.getElementById('commentSubmitBtn');
        const content = commentInput.value.trim();

        if (content) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('bg-[#ACA0EB]');
            submitBtn.classList.add('bg-[#7F6AEE]', 'hover:opacity-90');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.remove('bg-[#7F6AEE]', 'hover:opacity-90');
            submitBtn.classList.add('bg-[#ACA0EB]');
        }
    }

    // 게시글 로드
    async function loadPost() {
        try {
            currentPost = await api.posts.get(postId);

            const postDetail = document.getElementById('postDetail');
            const currentUserId = parseInt(storage.getUserId());
            const isAuthor = currentPost.author.id === currentUserId;

            let actionsHtml = '';
            if (isAuthor) {
                actionsHtml = `
                    <div class="flex gap-2 mt-2 sm:mt-0">
                        <button onclick="location.href='/posts/${postId}/edit'" class="px-4 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 text-sm text-gray-700">수정</button>
                        <button onclick="openDeleteModal()" class="px-4 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 text-sm text-gray-700">삭제</button>
                    </div>
                `;
            }

            const authorImageHtml = currentPost.author.profile_image 
                ? `<img src="${currentPost.author.profile_image}" class="w-full h-full object-cover rounded-full">` 
                : '';

            const postImage = currentPost.image_url
                ? `<img src="${currentPost.image_url}" class="max-w-full rounded-lg mb-6">`
                : '';

            postDetail.innerHTML = `
                <div class="border-b border-gray-200 pb-4 mb-6">
                    <h2 class="text-2xl font-bold mb-4 leading-tight break-words">${escapeHtml(currentPost.title)}</h2>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gray-200 mr-3 overflow-hidden">
                                ${authorImageHtml}
                            </div>
                            <div>
                                <div class="font-medium text-gray-900">${escapeHtml(currentPost.author.nickname)}</div>
                                <div class="text-xs text-gray-500">${utils.formatDate(currentPost.created_at)}</div>
                            </div>
                        </div>
                        ${actionsHtml}
                    </div>
                </div>
                
                ${postImage}
                
                <div class="py-4 text-gray-800 leading-relaxed whitespace-pre-wrap min-h-[100px] mb-8 text-lg">${escapeHtml(currentPost.content)}</div>
            `;

            document.getElementById('likeCount').textContent = utils.formatNumber(currentPost.like_count || 0);
            document.getElementById('viewCount').textContent = utils.formatNumber(currentPost.view_count || 0);
            document.getElementById('commentCount').textContent = utils.formatNumber(currentPost.comment_count || 0);

            loadLikeStatus();
            loadComments();
        } catch (error) {
            console.error('Load post error:', error);
            utils.showError(error.message || '게시글을 불러오는데 실패했습니다');
            if (error.message && error.message.includes('찾을 수')) {
                history.back();
            }
        }
    }

    // 댓글 로드
    async function loadComments() {
        try {
            const comments = await api.comments.list(postId);
            const commentsList = document.getElementById('commentsList');

            if (comments && comments.length > 0) {
                commentsList.innerHTML = '';
                const currentUserId = parseInt(storage.getUserId());

                comments.forEach(comment => {
                    const isAuthor = comment.author.id === currentUserId;
                    let actionsHtml = '';

                    if (isAuthor) {
                        actionsHtml = `
                            <div class="flex gap-2 text-xs mt-2">
                                <button onclick="editComment(${comment.id}, \`${comment.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-50 text-gray-600">수정</button>
                                <button onclick="deleteComment(${comment.id})" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-50 text-gray-600">삭제</button>
                            </div>
                        `;
                    }

                    const commentAuthorImageHtml = comment.author.profile_image
                        ? `<img src="${comment.author.profile_image}" class="w-full h-full object-cover rounded-full">`
                        : '';

                    const commentItem = document.createElement('div');
                    commentItem.className = 'border-b border-gray-100 py-4 last:border-0';
                    commentItem.id = `comment-${comment.id}`;
                    commentItem.innerHTML = `
                        <div class="flex items-center mb-2">
                            <div class="w-8 h-8 rounded-full bg-gray-200 mr-3 overflow-hidden">
                                ${commentAuthorImageHtml}
                            </div>
                            <div class="flex-1 flex justify-between items-center">
                                <div>
                                    <div class="font-medium text-sm text-gray-900">${escapeHtml(comment.author.nickname)}</div>
                                    <div class="text-xs text-gray-400">${utils.formatDate(comment.created_at)}</div>
                                </div>
                                ${actionsHtml}
                            </div>
                        </div>
                        <div class="text-gray-800 leading-relaxed">${escapeHtml(comment.content)}</div>
                    `;
                    commentsList.appendChild(commentItem);
                });
            } else {
                commentsList.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">첫 번째 댓글을 남겨주세요!</div>';
            }
        } catch (error) {
            console.error('Load comments error:', error);
        }
    }

    // 댓글 작성 또는 수정
    async function submitComment() {
        const commentInput = document.getElementById('commentInput');
        const submitBtn = document.getElementById('commentSubmitBtn');
        const content = commentInput.value.trim();

        if (!content) {
            utils.showError('댓글 내용을 입력해주세요');
            return;
        }

        try {
            if (editingCommentId) {
                // 댓글 수정
                await api.comments.update(editingCommentId, content);
                commentInput.value = '';
                editingCommentId = null;
                submitBtn.textContent = '댓글 등록';
                updateCommentButton();
                loadComments();
            } else {
                // 댓글 작성
                await api.comments.create(postId, content);
                commentInput.value = '';
                updateCommentButton();

                const countEl = document.getElementById('commentCount');
                let count = parseInt(countEl.textContent.replace(/,/g, '')) || 0;
                countEl.textContent = utils.formatNumber(count + 1);

                loadComments();
            }
        } catch (error) {
            console.error('Submit comment error:', error);
            utils.showError(error.message || '댓글 작성에 실패했습니다');
        }
    }

    // 게시글 삭제 모달
    function openDeleteModal() {
        document.getElementById('deleteModal').classList.remove('hidden');
        document.getElementById('deleteModal').classList.add('flex');
        document.body.classList.add('modal-open');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
        document.getElementById('deleteModal').classList.remove('flex');
        document.body.classList.remove('modal-open');
    }

    async function confirmDelete() {
        try {
            await api.posts.delete(postId);
            utils.showSuccess('게시글이 삭제되었습니다');
            location.href = '/posts';
        } catch (error) {
            console.error('Delete post error:', error);
            utils.showError(error.message || '게시글 삭제에 실패했습니다');
        }
        closeDeleteModal();
    }

    // 댓글 삭제
    function deleteComment(commentId) {
        deleteCommentId = commentId;
        document.getElementById('deleteCommentModal').classList.remove('hidden');
        document.getElementById('deleteCommentModal').classList.add('flex');
        document.body.classList.add('modal-open');
    }

    // 댓글 수정 (상단 입력창 사용)
    function editComment(commentId, content) {
        const commentInput = document.getElementById('commentInput');
        const submitBtn = document.getElementById('commentSubmitBtn');

        commentInput.value = content;
        editingCommentId = commentId;
        submitBtn.textContent = '댓글 수정';
        updateCommentButton();

        // 입력창으로 스크롤
        commentInput.focus();
        commentInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function closeDeleteCommentModal() {
        document.getElementById('deleteCommentModal').classList.add('hidden');
        document.getElementById('deleteCommentModal').classList.remove('flex');
        document.body.classList.remove('modal-open');
        deleteCommentId = null;
    }

    async function confirmDeleteComment() {
        if (!deleteCommentId) return;

        try {
            await api.comments.delete(deleteCommentId);
            
            const countEl = document.getElementById('commentCount');
            let count = parseInt(countEl.textContent.replace(/,/g, '')) || 0;
            countEl.textContent = utils.formatNumber(Math.max(0, count - 1));

            loadComments();
        } catch (error) {
            console.error('Delete comment error:', error);
            utils.showError(error.message || '댓글 삭제에 실패했습니다');
        }
        closeDeleteCommentModal();
    }

    // 초기 로드
    loadPost();
</script>
{% endblock %}